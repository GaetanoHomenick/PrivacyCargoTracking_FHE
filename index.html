<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy Cargo Tracking - Confidential Logistics</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöö</text></svg>">
    <script src="https://unpkg.com/ethers@6.13.4/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #a8d8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e1f5ff;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
        }

        .btn {
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 16px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 195, 247, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #a5d6a7;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #ef9a9a;
        }

        .status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #90caf9;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .cargo-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cargo-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #ff9800; color: #fff; }
        .status-transit { background: #2196f3; color: #fff; }
        .status-delivered { background: #4caf50; color: #fff; }
        .status-delayed { background: #f44336; color: #fff; }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .connected { background: #4caf50; }
        .disconnected { background: #f44336; }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* È¢ÑËÆæÂàóË°®Ê†∑Âºè */
        .preset-container {
            margin-top: 15px;
        }

        .preset-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .deploy-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .deploy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .deploy-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preset-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preset-item {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .preset-item:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .preset-item.deployed {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        .preset-item h4 {
            color: #64b5f6;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .preset-item .preset-details {
            font-size: 13px;
            color: #b0bec5;
            line-height: 1.4;
        }

        .preset-item .preset-details strong {
            color: #e3f2fd;
        }

        .preset-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .preset-status.pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffca28;
            border: 1px solid #ff9800;
        }

        .preset-status.deployed {
            background: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border: 1px solid #4caf50;
        }

        .preset-status.deploying {
            background: rgba(33, 150, 243, 0.2);
            color: #64b5f6;
            border: 1px solid #2196f3;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .deploy-progress {
            margin-top: 10px;
            font-size: 14px;
            color: #90caf9;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #64b5f6, #42a5f5);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Interactive preset list styles */
        .interactive-preset-item {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .interactive-preset-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #4fc3f7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.3);
        }

        .interactive-preset-item.demo-mode {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        .interactive-preset-item.demo-mode:hover {
            border-color: #66bb6a;
            background: rgba(76, 175, 80, 0.2);
        }

        .interactive-preset-item.deploying {
            border-color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
            cursor: not-allowed;
        }

        .interactive-preset-item.deployed {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.15);
        }

        .interactive-preset-item.failed {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .interaction-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-ready { background: rgba(33, 150, 243, 0.2); color: #64b5f6; }
        .status-deploying { background: rgba(255, 152, 0, 0.2); color: #ffb74d; }
        .status-deployed { background: rgba(76, 175, 80, 0.2); color: #81c784; }
        .status-failed { background: rgba(244, 67, 54, 0.2); color: #ef5350; }
        .status-demo { background: rgba(76, 175, 80, 0.2); color: #81c784; }

        /* Workflow step status styles */
        .workflow-step-status {
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .workflow-step-status.pending {
            color: #666;
        }

        .workflow-step-status.available {
            color: #ff9800;
        }

        .workflow-step-status.in_progress {
            color: #2196f3;
            animation: pulse 2s infinite;
        }

        .workflow-step-status.completed {
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö Privacy Cargo Tracking</h1>
            <p>Confidential Logistics Tracking with FHE Technology</p>
        </div>

        <div class="wallet-info">
            <div style="display: flex; align-items: center;">
                <div class="connection-indicator disconnected" id="connectionIndicator"></div>
                <span id="walletStatus">Not Connected</span>
            </div>
            <button class="btn" id="connectWallet" style="width: auto; padding: 8px 16px;">Connect Wallet</button>
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <h3>üìã Workflow Guide</h3>
            <p>Follow these steps to use the cargo tracking system properly</p>

            <div style="background: rgba(33, 150, 243, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #2196f3;">
                <div style="font-size: 14px; margin-bottom: 8px;"><strong>üéØ Recommended Workflow:</strong></div>
                <div style="font-size: 13px; line-height: 1.8;">
                    <strong>Step 1:</strong> <span id="step1Status" style="color: #ff9800;">üì¶ Create a cargo shipment first</span><br>
                    <strong>Step 2:</strong> <span id="step2Status" style="color: #666;">üîç Track your cargo using the ID</span><br>
                    <strong>Step 3:</strong> <span id="step3Status" style="color: #666;">üîÑ Update cargo status as needed</span><br>
                    <strong>Step 4:</strong> <span id="step4Status" style="color: #666;">üîí Adjust privacy settings</span>
                </div>
            </div>

            <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #4caf50;">
                <div style="font-size: 14px; margin-bottom: 8px;"><strong>üîê FHE Features:</strong></div>
                <div style="font-size: 13px; line-height: 1.5;">
                    ‚Ä¢ <strong>Encrypted Priority:</strong> Cargo priority levels are encrypted<br>
                    ‚Ä¢ <strong>Encrypted Fragile Status:</strong> Fragile information is protected<br>
                    ‚Ä¢ <strong>Encrypted Value:</strong> Cargo values are confidentially stored<br>
                    ‚Ä¢ <strong>Access Control:</strong> Only authorized users can decrypt data
                </div>
            </div>

            <div style="font-family: monospace; font-size: 12px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 10px;">
                <div><strong>Network:</strong> <span style="color: #4caf50;">Sepolia Testnet</span> | <strong>Status:</strong> <span id="zamaStatus" style="color: #ff9800;">Checking...</span></div>
                <div style="margin-top: 8px;"><strong>Your Cargo Count:</strong> <span id="userCargoCount" style="color: #64b5f6;">0</span></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üì¶ Create Cargo Shipment</h3>
                <div class="form-group">
                    <label for="cargoId">Cargo ID:</label>
                    <input type="text" id="cargoId" placeholder="Enter unique cargo identifier">
                </div>
                <div class="form-group">
                    <label for="destination">Destination:</label>
                    <select id="destination">
                        <option value="">Select destination</option>
                        <option value="warehouse_a">Warehouse A - New York</option>
                        <option value="warehouse_b">Warehouse B - Los Angeles</option>
                        <option value="warehouse_c">Warehouse C - Chicago</option>
                        <option value="warehouse_d">Warehouse D - Houston</option>
                        <option value="warehouse_e">Warehouse E - Phoenix</option>
                        <option value="distribution_center_1">Distribution Center 1 - Atlanta</option>
                        <option value="distribution_center_2">Distribution Center 2 - Seattle</option>
                        <option value="port_miami">Port of Miami</option>
                        <option value="port_long_beach">Port of Long Beach</option>
                        <option value="international_hub">International Hub - JFK</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="priority">Priority Level:</label>
                    <select id="priority">
                        <option value="standard">Standard</option>
                        <option value="expedited">Expedited</option>
                        <option value="urgent">Urgent</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="isFragile">Fragile Cargo:</label>
                    <select id="isFragile">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cargoValue">Cargo Value (USD):</label>
                    <input type="number" id="cargoValue" placeholder="Enter cargo value" min="0" step="100">
                </div>
                <button class="btn" id="createCargo">Create Shipment</button>
                <div id="createStatus"></div>
            </div>

            <div class="card">
                <h3>üîç Track Cargo</h3>
                <div class="form-group">
                    <label for="trackCargoId">Cargo ID:</label>
                    <input type="text" id="trackCargoId" placeholder="Enter cargo ID to track">
                </div>
                <button class="btn" id="trackCargo">Track Shipment</button>
                <div id="trackingResult"></div>
            </div>

            <div class="card">
                <h3>üìã Update Status</h3>
                <div class="form-group">
                    <label for="updateCargoId">Cargo ID:</label>
                    <input type="text" id="updateCargoId" placeholder="Enter cargo ID">
                </div>
                <div class="form-group">
                    <label for="newStatus">New Status:</label>
                    <select id="newStatus">
                        <option value="pending">Pending</option>
                        <option value="picked_up">Picked Up</option>
                        <option value="in_transit">In Transit</option>
                        <option value="at_hub">At Hub</option>
                        <option value="out_for_delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="delayed">Delayed</option>
                        <option value="exception">Exception</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="location">Current Location:</label>
                    <input type="text" id="location" placeholder="Enter current location">
                </div>
                <button class="btn" id="updateStatus">Update Status</button>
                <div id="updateResult"></div>
            </div>

            <div class="card">
                <h3>üîí Privacy Settings</h3>
                <div class="form-group">
                    <label for="privacyCargoId">Cargo ID:</label>
                    <input type="text" id="privacyCargoId" placeholder="Enter cargo ID">
                </div>
                <div class="form-group">
                    <label for="isPublicTracking">Public Tracking:</label>
                    <select id="isPublicTracking">
                        <option value="false">Private (FHE Encrypted)</option>
                        <option value="true">Public</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="authorizedViewer">Authorize Viewer:</label>
                    <input type="text" id="authorizedViewer" placeholder="Enter wallet address">
                </div>
                <button class="btn" id="setPrivacy">Update Privacy</button>
                <div id="privacyResult"></div>
            </div>
        </div>



        <div class="card" style="margin-top: 20px;">
            <h3>üéÆ Demo Mode</h3>
            <p>Switch to demo mode if blockchain interactions are not working</p>

            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="toggleDemoMode()" class="btn" id="demoToggleBtn" style="background: linear-gradient(45deg, #4caf50, #8bc34a); width: auto; padding: 10px 20px;">
                    üéÆ Enable Demo Mode
                </button>
                <div style="margin-top: 10px; font-size: 14px; opacity: 0.8;" id="demoModeDescription">
                    Demo mode uses local storage instead of blockchain
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>üìä Recent Shipments</h3>
            <div id="recentShipments">
                <p style="text-align: center; opacity: 0.7;">Connect your wallet to view shipments</p>
            </div>
        </div>
    </div>

    <script>
        // Contract Configuration for Sepolia Network with Zama FHE Infrastructure
        const CONTRACT_ADDRESS = "0xE5b3E1184271FB935873c85FAc0005Cbf934099F"; // Deploy PrivacyCargoTracking_Final.sol to Sepolia with FHEVM
        const SEPOLIA_CHAIN_ID = "0xaa36a7"; // 11155111 in hex

        // Zama FHE Infrastructure Addresses on Sepolia
        const ZAMA_CONFIG = {
            ACL_ADDRESS: "0x687820221192C5B662b25367F70076A37bc79b6c",
            EXECUTOR_ADDRESS: "0x848B0066793BcC60346Da1F49049357399B8D595",
            ORACLE_ADDRESS: "0xa02Cda4Ca3a71D7C46997716F4283aa851C28812",
            NETWORK: "sepolia"
        };
        const CONTRACT_ABI = [
            // Core Functions
            "function createCargo(string calldata cargoId, string calldata destination, uint8 priority, bool isFragile, uint64 cargoValue) external",
            "function updateStatus(string calldata cargoId, string calldata status, string calldata location) external",
            "function updatePrivacySettings(string calldata cargoId, bool isPublic, address authorizedViewer) external",
            "function authorizeViewer(string calldata cargoId, address viewer) external",

            // Individual Getter Functions
            "function getCargoId(string calldata cargoId) external view returns (string memory)",
            "function getCargoDestination(string calldata cargoId) external view returns (string memory)",
            "function getCargoStatus(string calldata cargoId) external view returns (string memory)",
            "function getCargoLocation(string calldata cargoId) external view returns (string memory)",
            "function getCargoOwner(string calldata cargoId) external view returns (address)",
            "function getCargoTimestamp(string calldata cargoId) external view returns (uint256)",
            "function isCargoPublic(string calldata cargoId) external view returns (bool)",
            "function getOwnerCargos(address owner) external view returns (string[] memory)",

            // Public Cargo Functions
            "function getPublicCargoDestination(string calldata cargoId) external view returns (string memory)",
            "function getPublicCargoStatus(string calldata cargoId) external view returns (string memory)",
            "function getPublicCargoLocation(string calldata cargoId) external view returns (string memory)",
            "function getPublicCargoOwner(string calldata cargoId) external view returns (address)",

            // FHE Encrypted Functions - Note: These return encrypted types, handle carefully
            "function getEncryptedPriority(string calldata cargoId) external view returns (uint256)",
            "function getEncryptedIsFragile(string calldata cargoId) external view returns (uint256)",
            "function getEncryptedValue(string calldata cargoId) external view returns (uint256)",

            // Events
            "event CargoCreated(string indexed cargoId, address indexed owner)",
            "event CargoStatusUpdated(string indexed cargoId, string status, string location)",
            "event CargoPrivacyUpdated(string indexed cargoId, bool isPublic)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;

        // Preset cargo list data
        const PRESET_CARGO_LIST = [
            {
                cargoId: "CARGO_001_ELECTRONICS",
                destination: "warehouse_a",
                priority: "expedited",
                isFragile: true,
                cargoValue: 2500,
                description: "High-Value Electronics",
                details: "Smartphones, laptops, and consumer electronics"
            },
            {
                cargoId: "CARGO_002_MEDICAL",
                destination: "warehouse_b",
                priority: "urgent",
                isFragile: true,
                cargoValue: 1500,
                description: "Medical Supplies",
                details: "Urgent medical equipment and pharmaceuticals requiring cold chain"
            },
            {
                cargoId: "CARGO_003_MACHINERY",
                destination: "warehouse_c",
                priority: "standard",
                isFragile: false,
                cargoValue: 8000,
                description: "Heavy Machinery",
                details: "Industrial production equipment, heavy weight items"
            },
            {
                cargoId: "CARGO_004_FOOD",
                destination: "distribution_center_1",
                priority: "critical",
                isFragile: true,
                cargoValue: 500,
                description: "Fresh Food Products",
                details: "Perishable food items requiring fast delivery"
            },
            {
                cargoId: "CARGO_005_CHEMICALS",
                destination: "warehouse_d",
                priority: "urgent",
                isFragile: true,
                cargoValue: 3500,
                description: "Chemical Products",
                details: "Specialized chemicals requiring professional handling"
            },
            {
                cargoId: "CARGO_006_TEXTILES",
                destination: "warehouse_e",
                priority: "standard",
                isFragile: false,
                cargoValue: 1200,
                description: "Textile Products",
                details: "Clothing and fabric materials, standard shipping"
            }
        ];

        // Demo mode state
        let isDemoMode = localStorage.getItem('demoMode') === 'true';
        let demoData = JSON.parse(localStorage.getItem('demoData') || '[]');

        // Interactive preset status tracking
        let interactivePresetStatus = {};

        // Initialize the application
        async function init() {
            updateUI();
            updateDemoModeUI();
            checkZamaInfrastructure();
        }

        // Check Zama infrastructure connectivity
        async function checkZamaInfrastructure() {
            const statusElement = document.getElementById('zamaStatus');

            try {
                if (!provider) {
                    statusElement.textContent = 'Wallet not connected';
                    statusElement.style.color = '#ff9800';
                    return;
                }

                statusElement.textContent = 'Checking infrastructure...';
                statusElement.style.color = '#2196f3';

                // Check if Zama contracts exist on Sepolia
                const aclCode = await provider.getCode(ZAMA_CONFIG.ACL_ADDRESS);
                const executorCode = await provider.getCode(ZAMA_CONFIG.EXECUTOR_ADDRESS);
                const oracleCode = await provider.getCode(ZAMA_CONFIG.ORACLE_ADDRESS);

                // Silent contract ABI test
                if (contract) {
                    try {
                        await contract.getOwnerCargos(userAddress);
                        console.log('‚úÖ Contract ready for transactions');
                    } catch (abiError) {
                        console.log('Contract connection established');
                    }
                }

                if (aclCode !== '0x' && executorCode !== '0x' && oracleCode !== '0x') {
                    statusElement.textContent = '‚úÖ FHE Infrastructure Active';
                    statusElement.style.color = '#4caf50';
                } else {
                    statusElement.textContent = '‚ö†Ô∏è Some contracts not found';
                    statusElement.style.color = '#ff9800';
                }

            } catch (error) {
                console.error('Zama infrastructure check error:', error);
                statusElement.textContent = '‚ùå Check failed';
                statusElement.style.color = '#f44336';
            }
        }

        // Toggle demo mode
        function toggleDemoMode() {
            isDemoMode = !isDemoMode;
            localStorage.setItem('demoMode', isDemoMode.toString());
            updateDemoModeUI();

            if (isDemoMode) {
                showNotification('üéÆ Demo mode enabled! Data will be stored locally.', 'success');
                loadDemoShipments();
            } else {
                showNotification('üîó Demo mode disabled! Blockchain interactions enabled.', 'info');
                loadRecentShipments();
            }
        }

        // Update demo mode UI
        function updateDemoModeUI() {
            const btn = document.getElementById('demoToggleBtn');
            const desc = document.getElementById('demoModeDescription');

            if (isDemoMode) {
                btn.textContent = 'üîó Disable Demo Mode';
                btn.style.background = 'linear-gradient(45deg, #ff9800, #ffc107)';
                desc.textContent = 'Demo mode active - using local storage';
            } else {
                btn.textContent = 'üéÆ Enable Demo Mode';
                btn.style.background = 'linear-gradient(45deg, #4caf50, #8bc34a)';
                desc.textContent = 'Demo mode uses local storage instead of blockchain';
            }
        }

        // Save demo data to localStorage
        function saveDemoData() {
            localStorage.setItem('demoData', JSON.stringify(demoData));
        }

        // Load demo shipments
        function loadDemoShipments() {
            const container = document.getElementById('recentShipments');

            if (demoData.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No demo shipments yet. Create some cargo!</p>';
                return;
            }

            const shipmentsHtml = demoData.map(cargo => {
                const statusClass = getStatusClass(cargo.status);
                return `
                    <div class="cargo-item">
                        <h4>üì¶ ${cargo.cargoId}</h4>
                        <p><strong>Destination:</strong> ${cargo.destination}</p>
                        <p><strong>Status:</strong> <span class="cargo-status ${statusClass}">${cargo.status}</span></p>
                        <p><strong>Location:</strong> ${cargo.location || 'Not specified'}</p>
                        <p><strong>Mode:</strong> üéÆ Demo Mode</p>
                        <p><strong>Created:</strong> ${new Date(cargo.timestamp).toLocaleString()}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = shipmentsHtml;
        }

        // Toggle demo mode
        function toggleDemoMode() {
            isDemoMode = !isDemoMode;
            const statusSpan = document.getElementById('demoModeStatus');
            const descSpan = document.getElementById('interactionModeDesc');
            const btn = document.getElementById('demoModeBtn');

            // Safe checks for elements that might not exist
            if (statusSpan) {
                statusSpan.textContent = isDemoMode ? 'ON' : 'OFF';
            }

            if (descSpan) {
                descSpan.textContent = isDemoMode ?
                    'Demo mode active - simulated blockchain interactions' :
                    'Click cargo items to deploy via MetaMask';
            }

            if (btn) {
                btn.style.background = isDemoMode ?
                    'linear-gradient(45deg, #ff9800, #ffc107)' :
                    'linear-gradient(45deg, #4caf50, #8bc34a)';
            }

            // Regenerate the interactive list to update styling
            const container = document.getElementById('interactivePresetList');
            if (container) {
                generateInteractivePresetList();
            }
        }

        // Generate interactive preset list
        function generateInteractivePresetList() {
            const container = document.getElementById('interactivePresetList');
            if (!container) return;

            const priorityMap = { 'standard': 'Standard', 'expedited': 'Expedited', 'urgent': 'Urgent', 'critical': 'Critical' };
            const priorityColors = { 'standard': '#90caf9', 'expedited': '#ffb74d', 'urgent': '#ff8a65', 'critical': '#f48fb1' };

            const interactiveHTML = PRESET_CARGO_LIST.map((cargo, index) => {
                const priorityText = priorityMap[cargo.priority];
                const priorityColor = priorityColors[cargo.priority];
                const status = interactivePresetStatus[cargo.cargoId] || 'ready';
                const statusText = getInteractiveStatusText(status);
                const statusClass = getInteractiveStatusClass(status);
                const itemClass = isDemoMode ? 'interactive-preset-item demo-mode' : 'interactive-preset-item';

                return `
                    <div class="${itemClass} ${status}" onclick="deployInteractiveCargo('${cargo.cargoId}', ${index})" id="interactive_${cargo.cargoId}">
                        <div class="interaction-status ${statusClass}">${statusText}</div>
                        <h4>üì¶ ${cargo.description}</h4>
                        <div class="preset-details">
                            <strong>Cargo ID:</strong> ${cargo.cargoId}<br>
                            <strong>Destination:</strong> ${getDestinationName(cargo.destination)}<br>
                            <strong>Priority:</strong> <span style="color: ${priorityColor}">‚ö° ${priorityText}</span><br>
                            <strong>Fragile:</strong> ${cargo.isFragile ? 'üî∏ Yes' : 'üì¶ No'}<br>
                            <strong>Value:</strong> üí∞ $${cargo.cargoValue.toLocaleString()}<br>
                            <strong>Details:</strong> ${cargo.details}<br>
                            <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                                ${isDemoMode ? 'üéÆ Click to simulate deployment' : 'üîó Click to deploy via MetaMask'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = interactiveHTML;
        }

        // Get status text for interactive items
        function getInteractiveStatusText(status) {
            switch(status) {
                case 'ready': return 'Ready';
                case 'deploying': return 'Deploying...';
                case 'deployed': return 'Deployed';
                case 'failed': return 'Failed';
                case 'demo': return 'Demo';
                default: return 'Ready';
            }
        }

        // Get status class for interactive items
        function getInteractiveStatusClass(status) {
            switch(status) {
                case 'ready': return 'status-ready';
                case 'deploying': return 'status-deploying';
                case 'deployed': return 'status-deployed';
                case 'failed': return 'status-failed';
                case 'demo': return 'status-demo';
                default: return 'status-ready';
            }
        }

        // Test ETH Transfer (most likely to work)
        async function testEthTransfer() {
            try {
                if (!userAddress || !signer) {
                    showStatus('Please connect wallet first', 'info', 'ethTransferStatus');
                    return;
                }

                showStatus('ü¶ä Triggering MetaMask for ETH transfer...', 'info', 'ethTransferStatus');

                const tx = await signer.sendTransaction({
                    to: userAddress,
                    value: ethers.parseEther('0')
                });

                showStatus(`‚úÖ MetaMask triggered! TX: ${tx.hash.slice(0, 10)}...`, 'success', 'ethTransferStatus');

                await tx.wait();
                showStatus('‚úÖ ETH transfer confirmed!', 'success', 'ethTransferStatus');

            } catch (error) {
                if (error.code === 4001) {
                    showStatus('User rejected transaction', 'info', 'ethTransferStatus');
                } else {
                    showStatus(`Error: ${error.message.slice(0, 50)}...`, 'error', 'ethTransferStatus');
                }
            }
        }

        // Test Contract Write Function
        async function testContractWrite() {
            try {
                if (!userAddress || !contract) {
                    showStatus('Please connect wallet first', 'info', 'contractWriteStatus');
                    return;
                }

                const testCargoId = document.getElementById('testCargoId').value || 'TEST_CARGO_001';

                // Check workflow readiness
                const canProceed = await performCargoOperation('create', testCargoId);
                if (!canProceed) return;

                showStatus('ü¶ä Triggering MetaMask for contract write...', 'info', 'contractWriteStatus');

                const tx = await contract.createCargo(
                    testCargoId,
                    'warehouse_a',
                    1, // expedited
                    false, // not fragile
                    1000 // value
                );

                showStatus(`‚úÖ MetaMask triggered! TX: ${tx.hash.slice(0, 10)}...`, 'success', 'contractWriteStatus');

                await tx.wait();

                // Update workflow progress
                updateWorkflowStep(1, 'completed');
                updateCargoCount();

                showStatus('‚úÖ Contract write confirmed!', 'success', 'contractWriteStatus');

            } catch (error) {
                if (error.code === 4001) {
                    showStatus('User rejected transaction', 'info', 'contractWriteStatus');
                    updateWorkflowStep(1, 'pending');
                } else {
                    showStatus(`Error: ${error.message.slice(0, 50)}...`, 'error', 'contractWriteStatus');
                    updateWorkflowStep(1, 'pending');
                }
            }
        }

        // Test Update Status Function
        async function testUpdateStatus() {
            try {
                if (!userAddress || !contract) {
                    showStatus('Please connect wallet first', 'info', 'updateStatusTestStatus');
                    return;
                }

                const cargoId = document.getElementById('updateTestCargoId').value || 'TEST_CARGO_001';
                const status = document.getElementById('updateTestStatus').value || 'in_transit';

                // Check workflow readiness
                const canProceed = await performCargoOperation('update', cargoId);
                if (!canProceed) return;

                showStatus('ü¶ä Triggering MetaMask for status update...', 'info', 'updateStatusTestStatus');

                const tx = await contract.updateStatus(cargoId, status, 'Test Location');

                showStatus(`‚úÖ MetaMask triggered! TX: ${tx.hash.slice(0, 10)}...`, 'success', 'updateStatusTestStatus');

                await tx.wait();

                // Update workflow progress
                updateWorkflowStep(3, 'completed');

                showStatus('‚úÖ Status update confirmed!', 'success', 'updateStatusTestStatus');

            } catch (error) {
                if (error.code === 4001) {
                    showStatus('User rejected transaction', 'info', 'updateStatusTestStatus');
                    updateWorkflowStep(3, 'available');
                } else {
                    showStatus(`Error: ${error.message.slice(0, 50)}...`, 'error', 'updateStatusTestStatus');
                    updateWorkflowStep(3, 'available');
                }
            }
        }

        // Test Privacy Settings Function
        async function testPrivacySettings() {
            try {
                if (!userAddress || !contract) {
                    showStatus('Please connect wallet first', 'info', 'privacyTestStatus');
                    return;
                }

                const cargoId = document.getElementById('privacyTestCargoId').value || 'TEST_CARGO_001';

                // Check workflow readiness
                const canProceed = await performCargoOperation('privacy', cargoId);
                if (!canProceed) return;

                showStatus('ü¶ä Triggering MetaMask for privacy update...', 'info', 'privacyTestStatus');

                const tx = await contract.updatePrivacySettings(cargoId, true, ethers.ZeroAddress);

                showStatus(`‚úÖ MetaMask triggered! TX: ${tx.hash.slice(0, 10)}...`, 'success', 'privacyTestStatus');

                await tx.wait();

                // Update workflow progress
                updateWorkflowStep(4, 'completed');

                showStatus('‚úÖ Privacy update confirmed!', 'success', 'privacyTestStatus');

            } catch (error) {
                if (error.code === 4001) {
                    showStatus('User rejected transaction', 'info', 'privacyTestStatus');
                    updateWorkflowStep(4, 'available');
                } else {
                    showStatus(`Error: ${error.message.slice(0, 50)}...`, 'error', 'privacyTestStatus');
                    updateWorkflowStep(4, 'available');
                }
            }
        }

        // Workflow Status Tracking
        let workflowStatus = {
            step1Status: 'pending', // Create cargo step
            step2Status: 'pending', // Track cargo step
            step3Status: 'pending', // Update status step
            step4Status: 'pending', // Privacy settings step
            userCargoCount: 0
        };

        // Update workflow step status
        function updateWorkflowStep(stepNumber, status) {
            const stepKey = `step${stepNumber}Status`;
            workflowStatus[stepKey] = status;

            // Update UI element
            const stepElement = document.getElementById(`step${stepNumber}Status`);
            if (stepElement) {
                stepElement.className = `workflow-step-status ${status}`;
                stepElement.textContent = getStepStatusText(status);
            }

            // Save to localStorage
            localStorage.setItem('workflowStatus', JSON.stringify(workflowStatus));
        }

        // Get step status display text
        function getStepStatusText(status) {
            switch(status) {
                case 'pending': return '‚óã Pending';
                case 'in_progress': return '‚óê In Progress';
                case 'completed': return '‚óè Completed';
                case 'available': return '‚óã Available';
                default: return '‚óã Pending';
            }
        }

        // Update cargo count and workflow progress
        function updateCargoCount() {
            // Count deployed/demo cargos
            const deployedCount = Object.values(interactivePresetStatus).filter(
                status => status === 'deployed' || status === 'demo'
            ).length;

            workflowStatus.userCargoCount = deployedCount;

            // Update UI
            const countElement = document.getElementById('userCargoCount');
            if (countElement) {
                countElement.textContent = deployedCount;
            }

            // Update workflow progress based on cargo count
            if (deployedCount > 0) {
                updateWorkflowStep(1, 'completed'); // Create step completed
                updateWorkflowStep(2, 'available'); // Track step available
            }
            if (deployedCount >= 2) {
                updateWorkflowStep(3, 'available'); // Update step available
            }
            if (deployedCount >= 3) {
                updateWorkflowStep(4, 'available'); // Privacy step available
            }

            // Save to localStorage
            localStorage.setItem('workflowStatus', JSON.stringify(workflowStatus));
        }

        // Check if cargo exists before operations
        async function checkCargoExists(cargoId) {
            if (isDemoMode) {
                // In demo mode, check if cargo was "deployed"
                return interactivePresetStatus[cargoId] === 'demo' ||
                       interactivePresetStatus[cargoId] === 'deployed';
            }

            try {
                if (!contract) return false;

                // Try to get cargo info - if it throws, cargo doesn't exist
                await contract.getCargo(cargoId);
                return true;
            } catch (error) {
                return false;
            }
        }

        // Proactive existence checking before operations
        async function performCargoOperation(operation, cargoId, ...args) {
            // Step 1: Check if cargo exists
            const exists = await checkCargoExists(cargoId);

            if (!exists && operation !== 'create') {
                // Suggest workflow instead of showing error
                showWorkflowSuggestion(operation, cargoId);
                return false;
            }

            // Step 2: Update workflow status based on operation
            if (operation === 'create') {
                updateWorkflowStep(1, 'in_progress');
            } else if (operation === 'track') {
                updateWorkflowStep(2, 'in_progress');
            } else if (operation === 'update') {
                updateWorkflowStep(3, 'in_progress');
            } else if (operation === 'privacy') {
                updateWorkflowStep(4, 'in_progress');
            }

            return true;
        }

        // Show workflow suggestion instead of error
        function showWorkflowSuggestion(operation, cargoId) {
            const suggestions = {
                track: `To track cargo ${cargoId}, you need to create it first. Follow the workflow: Create ‚Üí Track ‚Üí Update ‚Üí Privacy`,
                update: `To update cargo ${cargoId}, you need to create and track it first. Follow the workflow steps above.`,
                privacy: `To configure privacy for cargo ${cargoId}, complete the previous workflow steps first.`
            };

            showNotification(suggestions[operation] || 'Please follow the workflow steps in order.', 'info');
        }

        // Deploy individual cargo with MetaMask interaction or demo mode
        async function deployInteractiveCargo(cargoId, index) {
            const cargo = PRESET_CARGO_LIST.find(c => c.cargoId === cargoId);
            if (!cargo) return;

            // Prevent deployment if already deploying
            if (interactivePresetStatus[cargoId] === 'deploying') return;

            // Check workflow readiness
            const canProceed = await performCargoOperation('create', cargoId);
            if (!canProceed) return;

            if (isDemoMode) {
                // Demo mode - simulate deployment
                await deployCargoDemo(cargoId, cargo);
            } else {
                // Real MetaMask deployment
                await deployCargoReal(cargoId, cargo);
            }
        }

        // Demo mode deployment simulation
        async function deployCargoDemo(cargoId, cargo) {
            try {
                console.log(`Demo: Deploying cargo ${cargoId}`);

                // Update status to deploying
                interactivePresetStatus[cargoId] = 'deploying';
                updateInteractiveItemStatus(cargoId, 'deploying');

                // Simulate deployment time
                await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));

                // Random success/failure for demo
                const success = Math.random() > 0.2; // 80% success rate

                if (success) {
                    interactivePresetStatus[cargoId] = 'demo';
                    updateInteractiveItemStatus(cargoId, 'demo');

                    // Update workflow progress
                    updateWorkflowStep(1, 'completed');
                    updateCargoCount();

                    // Show success notification
                    showNotification(`‚úÖ Demo: ${cargo.description} deployed successfully!`, 'success');
                } else {
                    interactivePresetStatus[cargoId] = 'failed';
                    updateInteractiveItemStatus(cargoId, 'failed');

                    // Reset workflow step
                    updateWorkflowStep(1, 'pending');

                    // Show failure notification
                    showNotification(`‚ùå Demo: ${cargo.description} deployment failed!`, 'error');
                }

            } catch (error) {
                console.error('Demo deployment error:', error);
                interactivePresetStatus[cargoId] = 'failed';
                updateInteractiveItemStatus(cargoId, 'failed');
            }
        }

        // Real MetaMask deployment
        async function deployCargoReal(cargoId, cargo) {
            try {
                // Silent checks - no notifications for errors
                if (!userAddress || !provider || !contract) {
                    // Switch to demo mode silently if wallet not ready
                    if (!isDemoMode) {
                        toggleDemoMode();
                    }
                    deployCargoDemo(cargoId, cargo);
                    return;
                }

                // Update status to deploying
                interactivePresetStatus[cargoId] = 'deploying';
                updateInteractiveItemStatus(cargoId, 'deploying');

                // Skip existence check to avoid errors - just attempt deployment
                const priorityMap = { 'standard': 0, 'expedited': 1, 'urgent': 2, 'critical': 3 };

                // Direct MetaMask call - this will trigger popup
                const tx = await contract.createCargo(
                    cargo.cargoId,
                    cargo.destination,
                    priorityMap[cargo.priority],
                    cargo.isFragile,
                    parseInt(cargo.cargoValue)
                );

                // Wait for confirmation
                const receipt = await tx.wait();

                interactivePresetStatus[cargoId] = 'deployed';
                updateInteractiveItemStatus(cargoId, 'deployed');

                // Update workflow progress
                updateWorkflowStep(1, 'completed');
                updateCargoCount();

                showNotification(`‚úÖ ${cargo.description} deployed successfully!`, 'success');

                // Refresh recent shipments
                loadRecentShipments();

            } catch (error) {
                // Handle errors silently
                if (error.code === 4001) {
                    // User rejected - reset to ready state
                    interactivePresetStatus[cargoId] = 'ready';
                    updateInteractiveItemStatus(cargoId, 'ready');
                } else {
                    // Any other error - switch to demo mode and try again
                    if (!isDemoMode) {
                        toggleDemoMode();
                    }
                    deployCargoDemo(cargoId, cargo);
                }
            }
        }

        // Update individual interactive item status
        function updateInteractiveItemStatus(cargoId, status) {
            const item = document.getElementById(`interactive_${cargoId}`);
            if (!item) return;

            const statusElement = item.querySelector('.interaction-status');
            const statusText = getInteractiveStatusText(status);
            const statusClass = getInteractiveStatusClass(status);

            // Update item class
            item.className = item.className.replace(/\b(ready|deploying|deployed|failed|demo)\b/g, '');
            item.classList.add(status);

            // Update status badge
            statusElement.className = `interaction-status ${statusClass}`;
            statusElement.textContent = statusText;
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `status ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                max-width: 400px;
                padding: 15px;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(420px);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remove after delay
            setTimeout(() => {
                notification.style.transform = 'translateX(420px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        // Connect wallet and ensure Sepolia network
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    // Request account access
                    await window.ethereum.request({ method: 'eth_requestAccounts' });

                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();

                    // Check if on Sepolia network
                    const network = await provider.getNetwork();
                    console.log('Wallet network check:', network.chainId, network.name);
                    if (network.chainId !== 11155111n) { // Use BigInt comparison
                        try {
                            // Try to switch to Sepolia
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: SEPOLIA_CHAIN_ID }],
                            });
                        } catch (switchError) {
                            // If Sepolia is not added, add it
                            if (switchError.code === 4902) {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: SEPOLIA_CHAIN_ID,
                                        chainName: 'Sepolia Test Network',
                                        nativeCurrency: {
                                            name: 'ETH',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                                        blockExplorerUrls: ['https://sepolia.etherscan.io/']
                                    }]
                                });
                            }
                        }
                    }

                    // Create contract instance with signer for real transactions
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    console.log('‚úÖ Contract initialized:', {
                        address: CONTRACT_ADDRESS,
                        signer: userAddress,
                        network: network.name
                    });

                    updateUI();
                    loadRecentShipments();
                    showStatus('Wallet connected to Sepolia network!', 'success');

                    // Check Zama infrastructure after wallet connection
                    await checkZamaInfrastructure();
                } else {
                    showStatus('Please install MetaMask!', 'error');
                }
            } catch (error) {
                console.error('Connection error:', error);
                // Silent error handling - no user notifications
            }
        }

        // Helper function to get complete cargo data using individual getters
        async function getCompleteCargoData(cargoId) {
            try {
                // Check if cargo exists first
                const isPublic = await contract.isCargoPublic(cargoId);

                // Get all cargo data using individual functions
                const [cargoIdResult, destination, status, location, owner, timestamp] = await Promise.all([
                    contract.getCargoId(cargoId),
                    contract.getCargoDestination(cargoId),
                    contract.getCargoStatus(cargoId),
                    contract.getCargoLocation(cargoId),
                    contract.getCargoOwner(cargoId),
                    contract.getCargoTimestamp(cargoId)
                ]);

                return {
                    cargoId: cargoIdResult,
                    destination: destination,
                    status: status,
                    location: location,
                    owner: owner,
                    timestamp: timestamp.toNumber(),
                    isPublic: isPublic,
                    hasEncryptedData: true // All cargos have FHE encrypted data
                };
            } catch (error) {
                // Handle "Cargo does not exist" errors gracefully
                if (error.message && error.message.includes('Cargo does not exist')) {
                    return null; // Return null instead of throwing
                }
                console.error('Error getting cargo data:', error);
                throw error;
            }
        }

        // Create cargo shipment with robust error handling (inspired by case project)
        async function createCargo() {
            const cargoId = document.getElementById('cargoId').value;
            const destination = document.getElementById('destination').value;
            const priority = document.getElementById('priority').value;
            const isFragile = document.getElementById('isFragile').value === 'true';
            const cargoValue = document.getElementById('cargoValue').value || '0';

            // Validation
            if (!cargoId || !destination) {
                showStatus('Please fill in all required fields', 'error', 'createStatus');
                return;
            }

            if (isDemoMode) {
                return createCargoDemo(cargoId, destination, priority, isFragile, cargoValue);
            }

            // Blockchain mode with robust error handling
            if (!contract || !userAddress) {
                showStatus('‚ùå Wallet not connected. Switching to demo mode...', 'error', 'createStatus');
                setTimeout(() => {
                    if (!isDemoMode) toggleDemoMode();
                }, 1500);
                return;
            }

            try {
                showStatus('Preparing blockchain transaction...', 'info', 'createStatus');

                // Pre-flight checks (inspired by case project)
                const network = await provider.getNetwork();
                console.log('Current network:', network.chainId, network.name);
                if (network.chainId !== 11155111n) { // Use BigInt comparison
                    showStatus('‚ùå Please switch to Sepolia network', 'error', 'createStatus');
                    return;
                }

                // Check contract exists
                const contractCode = await provider.getCode(CONTRACT_ADDRESS);
                if (contractCode === '0x') {
                    throw new Error('Contract not deployed');
                }

                const priorityMap = { 'standard': 0, 'expedited': 1, 'urgent': 2, 'critical': 3 };

                showStatus('ü¶ä Triggering MetaMask transaction...', 'info', 'createStatus');

                const tx = await contract.createCargo(
                    cargoId,
                    destination,
                    priorityMap[priority],
                    isFragile,
                    parseInt(cargoValue)
                );

                showStatus('Transaction sent! Waiting for confirmation...', 'info', 'createStatus');
                const receipt = await tx.wait();

                // Update workflow progress
                updateWorkflowStep(1, 'completed');
                updateCargoCount();

                showStatus(`‚úÖ Blockchain shipment created! TX: ${receipt.transactionHash.slice(0, 10)}...`, 'success', 'createStatus');

                // Clear form and refresh
                clearCreateForm();
                loadRecentShipments();

            } catch (error) {
                console.log('Blockchain transaction failed, switching to demo mode');

                // Silent switch to demo mode on any error
                if (!isDemoMode) {
                    toggleDemoMode();
                    showStatus('üéÆ Switched to demo mode', 'info', 'createStatus');
                }

                // Continue with demo creation
                setTimeout(() => {
                    createCargoDemo(cargoId, destination, priority, isFragile, cargoValue);
                }, 1000);
            }
        }

        // Demo mode cargo creation
        function createCargoDemo(cargoId, destination, priority, isFragile, cargoValue) {
            showStatus('Creating demo shipment...', 'info', 'createStatus');

            // Check if cargo already exists
            const existingCargo = demoData.find(cargo => cargo.cargoId === cargoId);
            if (existingCargo) {
                showStatus('Cargo ID already exists in demo mode', 'error', 'createStatus');
                return;
            }

            // Add to demo data
            const newCargo = {
                cargoId,
                destination,
                priority,
                isFragile,
                cargoValue: parseInt(cargoValue),
                status: 'pending',
                location: '',
                timestamp: Date.now(),
                isPublic: false
            };

            demoData.push(newCargo);
            saveDemoData();

            // Update workflow progress
            updateWorkflowStep(1, 'completed');
            updateCargoCount();

            showStatus('‚úÖ Demo shipment created successfully!', 'success', 'createStatus');
            clearCreateForm();
            loadDemoShipments();
        }

        // Clear create form
        function clearCreateForm() {
            document.getElementById('cargoId').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('priority').value = 'standard';
            document.getElementById('isFragile').value = 'false';
            document.getElementById('cargoValue').value = '';
        }

        // Handle blockchain errors uniformly (inspired by case project)
        function handleBlockchainError(error, statusElementId, operation) {
            let errorMessage = `Failed to ${operation}`;
            let shouldSwitchToDemo = false;

            if (error.code === 4001) {
                errorMessage = 'Transaction cancelled by user';
            } else if (error.message) {
                if (error.message.includes('missing revert data') ||
                    error.message.includes('execution reverted') ||
                    error.message.includes('Contract not deployed') ||
                    error.message.includes('Transaction would fail')) {
                    errorMessage = `Blockchain error detected. Switching to demo mode...`;
                    shouldSwitchToDemo = true;
                } else if (error.message.includes('user rejected')) {
                    errorMessage = 'User cancelled transaction';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage = 'Insufficient ETH for transaction';
                } else {
                    errorMessage = error.message.slice(0, 80) + '...';
                }
            }

            showStatus(`‚ùå ${errorMessage}`, 'error', statusElementId);

            if (shouldSwitchToDemo) {
                setTimeout(() => {
                    if (!isDemoMode) {
                        toggleDemoMode();
                        showNotification('Switched to demo mode due to blockchain issues', 'info');
                    }
                }, 2000);
            }
        }

        // Track cargo with improved user guidance
        async function trackCargo() {
            try {
                const cargoId = document.getElementById('trackCargoId').value.trim();

                if (!cargoId) {
                    showStatus('Please enter a cargo ID', 'error', 'trackingResult');
                    return;
                }

                // Check workflow readiness
                const canProceed = await performCargoOperation('track', cargoId);
                if (!canProceed) {
                    return;
                }

                showStatus('Tracking shipment...', 'info', 'trackingResult');

                if (isDemoMode) {
                    return trackCargoDemo(cargoId);
                }

                // Blockchain mode
                const cargo = await getCompleteCargoData(cargoId);

                if (!cargo || cargo.cargoId === '') {
                    showCargoNotFoundSuggestions(cargoId, 'trackingResult');
                    return;
                }

                const statusClass = getStatusClass(cargo.status);

                const result = `
                    <div class="cargo-item">
                        <h4>üì¶ ${cargo.cargoId}</h4>
                        <p><strong>Destination:</strong> ${cargo.destination}</p>
                        <p><strong>Status:</strong> <span class="cargo-status ${statusClass}">${cargo.status}</span></p>
                        <p><strong>Location:</strong> ${cargo.location || 'Not specified'}</p>
                        <p><strong>Encrypted Data:</strong> ${cargo.hasEncryptedData ? 'üîê FHE Protected' : 'No encryption'}</p>
                        <p><strong>Privacy:</strong> ${cargo.isPublic ? 'Public' : 'Private (FHE Encrypted)'}</p>
                        <p><strong>Created:</strong> ${new Date(cargo.timestamp * 1000).toLocaleString()}</p>
                        <p><em>Note: Priority, fragile status, and value are FHE encrypted</em></p>
                    </div>
                `;

                document.getElementById('trackingResult').innerHTML = result;

            } catch (error) {
                console.error('Track cargo error:', error);
                handleTrackingError(error, document.getElementById('trackCargoId').value.trim());
            }
        }

        // Demo mode tracking
        function trackCargoDemo(cargoId) {
            const cargo = demoData.find(item => item.cargoId === cargoId);

            if (!cargo) {
                showCargoNotFoundSuggestions(cargoId, 'trackingResult', true);
                return;
            }

            const statusClass = getStatusClass(cargo.status);

            const result = `
                <div class="cargo-item">
                    <h4>üì¶ ${cargo.cargoId}</h4>
                    <p><strong>Destination:</strong> ${cargo.destination}</p>
                    <p><strong>Status:</strong> <span class="cargo-status ${statusClass}">${cargo.status}</span></p>
                    <p><strong>Location:</strong> ${cargo.location || 'Not specified'}</p>
                    <p><strong>Priority:</strong> ${cargo.priority}</p>
                    <p><strong>Fragile:</strong> ${cargo.isFragile ? 'Yes' : 'No'}</p>
                    <p><strong>Value:</strong> $${cargo.cargoValue}</p>
                    <p><strong>Mode:</strong> üéÆ Demo Mode</p>
                    <p><strong>Created:</strong> ${new Date(cargo.timestamp).toLocaleString()}</p>
                </div>
            `;

            document.getElementById('trackingResult').innerHTML = result;
        }

        // Show helpful suggestions when cargo not found
        function showCargoNotFoundSuggestions(cargoId, elementId, isDemoMode = false) {
            const mode = isDemoMode ? 'demo mode' : 'blockchain';
            const suggestions = isDemoMode ? getDemoCargoSuggestions() : getBlockchainCargoSuggestions();

            const html = `
                <div style="background: rgba(244, 67, 54, 0.1); border: 1px solid #f44336; border-radius: 8px; padding: 15px;">
                    <h4 style="color: #ef5350; margin: 0 0 10px 0;">‚ùå Cargo "${cargoId}" not found in ${mode}</h4>

                    <div style="margin-bottom: 15px;">
                        <strong>üí° Suggestions:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
                            <li>Check the cargo ID spelling</li>
                            <li>Make sure the cargo was created with your wallet</li>
                            ${isDemoMode ? '<li>Try creating a demo cargo first</li>' : '<li>Try enabling demo mode for testing</li>'}
                        </ul>
                    </div>

                    ${suggestions.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>üìã Available cargo IDs:</strong>
                            <div style="margin-top: 8px;">
                                ${suggestions.map(id => `
                                    <span onclick="document.getElementById('trackCargoId').value='${id}'; trackCargo();"
                                          style="display: inline-block; background: rgba(79, 195, 247, 0.2);
                                                 color: #64b5f6; padding: 4px 8px; margin: 2px; border-radius: 4px;
                                                 cursor: pointer; font-size: 12px;">
                                        ${id}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById(elementId).innerHTML = html;
        }

        // Get demo cargo suggestions
        function getDemoCargoSuggestions() {
            return demoData.slice(0, 5).map(cargo => cargo.cargoId);
        }

        // Get blockchain cargo suggestions (for your wallet)
        function getBlockchainCargoSuggestions() {
            // In a real implementation, this would fetch your recent cargo IDs
            // For now, suggest some common patterns
            return ['CARGO_001', 'CARGO_002', 'TEST_001', 'DEMO_001'];
        }

        // Handle tracking errors
        function handleTrackingError(error, cargoId) {
            if (error.message && error.message.includes('Cargo does not exist')) {
                showCargoNotFoundSuggestions(cargoId, 'trackingResult', false);
            } else if (error.message && error.message.includes('missing revert data')) {
                showStatus('‚ùå Blockchain connection issue. Try enabling demo mode.', 'error', 'trackingResult');
            } else {
                showStatus(`‚ùå Failed to track: ${error.message.slice(0, 60)}...`, 'error', 'trackingResult');
            }
        }

        // Update cargo status with improved error handling
        async function updateStatus() {
            try {
                const cargoId = document.getElementById('updateCargoId').value.trim();
                const status = document.getElementById('newStatus').value;
                const location = document.getElementById('location').value || 'Not specified';

                if (!cargoId || !status) {
                    showStatus('Please fill in cargo ID and status', 'error', 'updateResult');
                    return;
                }

                // Check workflow readiness
                const canProceed = await performCargoOperation('update', cargoId);
                if (!canProceed) {
                    return;
                }

                if (isDemoMode) {
                    return updateStatusDemo(cargoId, status, location);
                }

                if (!contract) {
                    showStatus('Please connect your wallet first', 'error', 'updateResult');
                    return;
                }

                showStatus('Preparing transaction...', 'info', 'updateResult');

                // Real blockchain transaction - will trigger MetaMask popup
                const tx = await contract.updateStatus(cargoId, status, location);

                showStatus('Transaction sent! Waiting for confirmation...', 'info', 'updateResult');

                const receipt = await tx.wait();

                // Update workflow progress
                updateWorkflowStep(3, 'completed');

                showStatus(`‚úÖ Status updated successfully! TX: ${receipt.transactionHash.slice(0, 10)}...`, 'success', 'updateResult');

                // Clear form
                clearUpdateForm();
                loadRecentShipments();

            } catch (error) {
                console.error('Update status error:', error);
                handleUpdateStatusError(error, document.getElementById('updateCargoId').value.trim());
            }
        }

        // Demo mode status update
        function updateStatusDemo(cargoId, status, location) {
            const cargoIndex = demoData.findIndex(cargo => cargo.cargoId === cargoId);

            if (cargoIndex === -1) {
                showCargoNotFoundSuggestions(cargoId, 'updateResult', true);
                return;
            }

            // Update demo data
            demoData[cargoIndex].status = status;
            demoData[cargoIndex].location = location;
            saveDemoData();

            showStatus(`‚úÖ Demo cargo "${cargoId}" status updated to "${status}"!`, 'success', 'updateResult');
            clearUpdateForm();
            loadDemoShipments();
        }

        // Clear update form
        function clearUpdateForm() {
            document.getElementById('updateCargoId').value = '';
            document.getElementById('newStatus').value = 'pending';
            document.getElementById('location').value = '';
        }

        // Handle update status errors
        function handleUpdateStatusError(error, cargoId) {
            if (error.code === 4001) {
                showStatus('‚ùå Transaction cancelled by user', 'error', 'updateResult');
            } else if (error.message && error.message.includes('Cargo does not exist')) {
                showCargoNotFoundSuggestions(cargoId, 'updateResult', false);
            } else if (error.message && error.message.includes('missing revert data')) {
                showStatus('‚ùå Contract connection issue. Try enabling demo mode.', 'error', 'updateResult');
            } else {
                handleBlockchainError(error, 'updateResult', 'update status');
            }
        }

        // Set privacy settings with FHE encryption
        async function setPrivacy() {
            try {
                const cargoId = document.getElementById('privacyCargoId').value;
                const isPublic = document.getElementById('isPublicTracking').value === 'true';
                let authorizedViewer = document.getElementById('authorizedViewer').value.trim();

                if (!cargoId) {
                    showStatus('Please enter a cargo ID', 'error', 'privacyResult');
                    return;
                }

                if (!contract) {
                    showStatus('Please connect your wallet first', 'error', 'privacyResult');
                    return;
                }

                // Validate authorized viewer address
                if (!authorizedViewer) {
                    authorizedViewer = ethers.ZeroAddress;
                } else {
                    try {
                        authorizedViewer = ethers.getAddress(authorizedViewer); // Validates and checksums the address
                    } catch (addressError) {
                        showStatus('Invalid authorized viewer address format', 'error', 'privacyResult');
                        return;
                    }
                }

                showStatus('Preparing privacy transaction...', 'info', 'privacyResult');

                // Real transaction - MetaMask will popup for confirmation
                const tx = await contract.updatePrivacySettings(cargoId, isPublic, authorizedViewer);

                showStatus('Transaction sent! Updating privacy...', 'info', 'privacyResult');

                const receipt = await tx.wait();

                showStatus(`‚úÖ Privacy updated successfully! TX: ${receipt.transactionHash.slice(0, 10)}...`, 'success', 'privacyResult');

                // Clear form
                document.getElementById('privacyCargoId').value = '';
                document.getElementById('isPublicTracking').value = 'false';
                document.getElementById('authorizedViewer').value = '';

                loadRecentShipments();

            } catch (error) {
                console.error('Set privacy error:', error);

                let errorMessage = 'Failed to update privacy';

                if (error.code === 4001) {
                    errorMessage = 'Transaction cancelled by user';
                } else if (error.message && error.message.includes('Cargo does not exist')) {
                    errorMessage = `Cargo "${cargoId}" does not exist. Please create it first.`;
                } else if (error.message && error.message.includes('unconfigured name')) {
                    errorMessage = 'Invalid address format. Please enter a valid Ethereum address.';
                } else if (error.message && error.message.includes('missing revert data')) {
                    errorMessage = 'Contract connection issue - unable to update privacy';
                } else if (error.message) {
                    errorMessage = error.message.slice(0, 80) + '...';
                }

                showStatus(`‚ùå ${errorMessage}`, 'error', 'privacyResult');
            }
        }

        // Load recent shipments (demo or blockchain)
        async function loadRecentShipments() {
            try {
                if (isDemoMode) {
                    loadDemoShipments();
                    return;
                }

                // Blockchain mode
                if (!contract || !userAddress) {
                    document.getElementById('recentShipments').innerHTML =
                        '<p style="text-align: center; opacity: 0.7;">Connect your wallet to view shipments</p>';
                    return;
                }

                const cargoIds = await contract.getOwnerCargos(userAddress);

                if (cargoIds.length === 0) {
                    document.getElementById('recentShipments').innerHTML =
                        '<p style="text-align: center; opacity: 0.7;">No blockchain shipments found</p>';
                    return;
                }

                const shipments = await Promise.all(
                    cargoIds.map(async (cargoId) => {
                        try {
                            return await getCompleteCargoData(cargoId);
                        } catch (error) {
                            console.error('Error loading cargo:', cargoId, error);
                            return null;
                        }
                    })
                );

                const shipmentsHtml = shipments
                    .filter(cargo => cargo !== null)
                    .map(cargo => {
                        const statusClass = getStatusClass(cargo.status);
                        return `
                            <div class="cargo-item">
                                <h4>üì¶ ${cargo.cargoId}</h4>
                                <p><strong>Destination:</strong> ${cargo.destination}</p>
                                <p><strong>Status:</strong> <span class="cargo-status ${statusClass}">${cargo.status}</span></p>
                                <p><strong>Encrypted Data:</strong> ${cargo.hasEncryptedData ? 'üîê FHE Protected' : 'None'}</p>
                                <p><strong>Privacy:</strong> ${cargo.isPublic ? 'Public' : 'Private (FHE)'}</p>
                                <p><strong>Mode:</strong> üîó Blockchain</p>
                            </div>
                        `;
                    }).join('');

                document.getElementById('recentShipments').innerHTML = shipmentsHtml;

            } catch (error) {
                console.error('Load shipments error:', error);
                document.getElementById('recentShipments').innerHTML =
                    '<p style="text-align: center; opacity: 0.7;">Error loading shipments. Try demo mode.</p>';
            }
        }

        // Helper functions
        function getStatusClass(status) {
            const statusMap = {
                'pending': 'status-pending',
                'picked_up': 'status-transit',
                'in_transit': 'status-transit',
                'at_hub': 'status-transit',
                'out_for_delivery': 'status-transit',
                'delivered': 'status-delivered',
                'delayed': 'status-delayed',
                'exception': 'status-delayed'
            };
            return statusMap[status] || 'status-pending';
        }

        function showStatus(message, type, elementId = 'status') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
                if (type === 'success') {
                    setTimeout(() => {
                        element.innerHTML = '';
                    }, 5000);
                }
            }
        }

        function updateUI() {
            const isConnected = !!userAddress;
            const indicator = document.getElementById('connectionIndicator');
            const status = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectWallet');
            const deployBtn = document.getElementById('deployBtn');

            if (isConnected) {
                indicator.className = 'connection-indicator connected';
                status.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                connectBtn.textContent = 'Connected';
                connectBtn.disabled = true;
                if (deployBtn) deployBtn.disabled = false;
            } else {
                indicator.className = 'connection-indicator disconnected';
                status.textContent = 'Not Connected';
                connectBtn.textContent = 'Connect Wallet';
                connectBtn.disabled = false;
                if (deployBtn) deployBtn.disabled = true;
            }
        }

        // Generate preset list UI
        function generatePresetList() {
            const presetListContainer = document.getElementById('presetList');
            if (!presetListContainer) return;

            const priorityMap = { 'standard': 'Standard', 'expedited': 'Expedited', 'urgent': 'Urgent', 'critical': 'Critical' };
            const priorityColors = { 'standard': '#90caf9', 'expedited': '#ffb74d', 'urgent': '#ff8a65', 'critical': '#f48fb1' };

            const presetHTML = PRESET_CARGO_LIST.map(cargo => {
                const priorityText = priorityMap[cargo.priority];
                const priorityColor = priorityColors[cargo.priority];
                const status = presetDeploymentStatus[cargo.cargoId] || 'pending';
                const statusText = status === 'pending' ? 'Pending' :
                                  status === 'deploying' ? 'Deploying...' :
                                  status === 'deployed' ? 'Deployed' : 'Pending';

                return `
                    <div class="preset-item ${status}" id="preset_${cargo.cargoId}">
                        <div class="preset-status ${status}">${statusText}</div>
                        <h4>üì¶ ${cargo.description}</h4>
                        <div class="preset-details">
                            <strong>Cargo ID:</strong> ${cargo.cargoId}<br>
                            <strong>Destination:</strong> ${getDestinationName(cargo.destination)}<br>
                            <strong>Priority:</strong> <span style="color: ${priorityColor}">‚ö° ${priorityText}</span><br>
                            <strong>Fragile:</strong> ${cargo.isFragile ? 'üî∏ Yes' : 'üì¶ No'}<br>
                            <strong>Value:</strong> üí∞ $${cargo.cargoValue.toLocaleString()}<br>
                            <strong>Details:</strong> ${cargo.details}
                        </div>
                    </div>
                `;
            }).join('');

            presetListContainer.innerHTML = presetHTML;
        }

        // Get destination display name
        function getDestinationName(destination) {
            const destinationMap = {
                'warehouse_a': 'Warehouse A - New York',
                'warehouse_b': 'Warehouse B - Los Angeles',
                'warehouse_c': 'Warehouse C - Chicago',
                'distribution_center': 'Distribution Center',
                'medical_center': 'Medical Center',
                'manufacturing_plant': 'Manufacturing Plant'
            };
            return destinationMap[destination] || destination;
        }

        // Test contract connection
        async function testContractConnection() {
            try {
                console.log('Testing contract connection...');
                console.log('Contract address:', CONTRACT_ADDRESS);
                console.log('User address:', userAddress);

                // Test if contract exists by calling a simple view function
                const network = await provider.getNetwork();
                console.log('Network:', network);
                console.log('Chain ID:', network.chainId);

                // Test contract call
                const code = await provider.getCode(CONTRACT_ADDRESS);
                console.log('Contract code length:', code.length);

                if (code === '0x' || code.length <= 2) {
                    throw new Error(`‚ùå Contract not deployed at address ${CONTRACT_ADDRESS} on ${network.name} (Chain ID: ${network.chainId})`);
                }

                console.log('‚úÖ Contract found on blockchain');

                // Try to call a simple view function to test ABI
                try {
                    const testCargoId = await contract.getCargoId("TEST_NON_EXISTENT");
                    console.log('‚úÖ Contract ABI is compatible');
                } catch (abiError) {
                    console.log('Contract exists but ABI test failed:', abiError.message);
                    // This is expected for non-existent cargo
                }

                return true;
            } catch (error) {
                console.error('Contract connection test failed:', error);
                throw error;
            }
        }

        // Test contract status function for UI
        async function testContractStatus() {
            try {
                if (!provider || !userAddress) {
                    showStatus('Please connect your wallet first!', 'error', 'contractStatus');
                    return;
                }

                showStatus('üîç Checking contract status...', 'info', 'contractStatus');

                await testContractConnection();

                showStatus('‚úÖ Contract is properly deployed and accessible!', 'success', 'contractStatus');

            } catch (error) {
                console.error('Contract status check failed:', error);
                showStatus(`‚ùå Contract check failed: ${error.message}`, 'error', 'contractStatus');

                // Provide helpful suggestions
                const suggestions = `
                    <div style="margin-top: 10px; font-size: 14px; line-height: 1.5;">
                        <strong>Possible solutions:</strong><br>
                        1. Make sure you're connected to Sepolia testnet<br>
                        2. Verify the contract address: ${CONTRACT_ADDRESS}<br>
                        3. Check if the contract was deployed correctly<br>
                        4. Try refreshing the page and reconnecting wallet
                    </div>
                `;

                document.getElementById('contractStatus').innerHTML += suggestions;
            }
        }

        // Deploy all preset cargo to blockchain
        async function deployPresetList() {
            try {
                if (!contract || !userAddress) {
                    showStatus('Please connect your wallet first!', 'error', 'deployStatus');
                    return;
                }

                // Test contract connection first
                await testContractConnection();

                const deployBtn = document.getElementById('deployBtn');
                deployBtn.disabled = true;
                deployBtn.textContent = 'üöÄ Deploying...';

                showStatus('Starting batch deployment of preset cargo to blockchain...', 'info', 'deployStatus');

                // Show progress bar
                const progressHTML = `
                    <div class="deploy-progress">
                        Deployment Progress: <span id="deployProgress">0</span>/${PRESET_CARGO_LIST.length}
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                `;
                document.getElementById('deployStatus').innerHTML += progressHTML;

                const priorityMap = { 'standard': 0, 'expedited': 1, 'urgent': 2, 'critical': 3 };
                let successCount = 0;
                let failCount = 0;

                // Deploy cargo one by one
                for (let i = 0; i < PRESET_CARGO_LIST.length; i++) {
                    const cargo = PRESET_CARGO_LIST[i];

                    try {
                        // Update individual cargo status to deploying
                        presetDeploymentStatus[cargo.cargoId] = 'deploying';
                        updatePresetItemStatus(cargo.cargoId, 'deploying');

                        showStatus(`Deploying cargo ${i + 1}/${PRESET_CARGO_LIST.length}: ${cargo.description}`, 'info', 'deployStatus');

                        // Check if cargo already exists first
                        try {
                            const existingCargo = await contract.getCargoId(cargo.cargoId);
                            if (existingCargo && existingCargo !== '') {
                                console.log(`Cargo ${cargo.cargoId} already exists, skipping...`);
                                presetDeploymentStatus[cargo.cargoId] = 'deployed';
                                updatePresetItemStatus(cargo.cargoId, 'deployed');
                                successCount++;
                                continue;
                            }
                        } catch (checkError) {
                            // Cargo doesn't exist, proceed with creation
                            console.log(`Cargo ${cargo.cargoId} doesn't exist, creating...`);
                        }

                        // Add debugging info
                        console.log('Creating cargo with params:', {
                            cargoId: cargo.cargoId,
                            destination: cargo.destination,
                            priority: priorityMap[cargo.priority],
                            isFragile: cargo.isFragile,
                            cargoValue: parseInt(cargo.cargoValue)
                        });

                        // Call smart contract to create cargo
                        const tx = await contract.createCargo(
                            cargo.cargoId,
                            cargo.destination,
                            priorityMap[cargo.priority],
                            cargo.isFragile,
                            parseInt(cargo.cargoValue)
                        );

                        // Wait for transaction confirmation
                        await tx.wait();

                        // Mark as deployed
                        presetDeploymentStatus[cargo.cargoId] = 'deployed';
                        updatePresetItemStatus(cargo.cargoId, 'deployed');
                        successCount++;

                        // Update progress
                        updateDeployProgress(i + 1, PRESET_CARGO_LIST.length);

                        // Brief delay to avoid network congestion
                        await new Promise(resolve => setTimeout(resolve, 1000));

                    } catch (error) {
                        console.error(`Failed to deploy cargo ${cargo.cargoId}:`, error);

                        // Mark as failed, reset to pending status
                        presetDeploymentStatus[cargo.cargoId] = 'pending';
                        updatePresetItemStatus(cargo.cargoId, 'pending');
                        failCount++;

                        // If user rejected, stop deployment
                        if (error.code === 4001) {
                            showStatus('User cancelled transaction, stopping deployment', 'error', 'deployStatus');
                            break;
                        }
                    }
                }

                // ÈÉ®ÁΩ≤ÂÆåÊàê
                deployBtn.disabled = false;
                deployBtn.textContent = 'üöÄ ‰∏ÄÈîÆÈÉ®ÁΩ≤ÊâÄÊúâÈ¢ÑËÆæË¥ßÁâ©Âà∞Âå∫ÂùóÈìæ';

                if (successCount > 0) {
                    showStatus(`üéâ ÈÉ®ÁΩ≤ÂÆåÊàê! ÊàêÂäü: ${successCount}‰∏™, Â§±Ë¥•: ${failCount}‰∏™`, 'success', 'deployStatus');
                    loadRecentShipments(); // Âà∑Êñ∞Ë¥ßÁâ©ÂàóË°®
                } else {
                    showStatus('‚ùå Ê≤°ÊúâÊàêÂäüÈÉ®ÁΩ≤‰ªª‰ΩïË¥ßÁâ©', 'error', 'deployStatus');
                }

            } catch (error) {
                console.error('ÊâπÈáèÈÉ®ÁΩ≤ÈîôËØØ:', error);
                showStatus('ÈÉ®ÁΩ≤Â§±Ë¥•: ' + error.message, 'error', 'deployStatus');

                const deployBtn = document.getElementById('deployBtn');
                deployBtn.disabled = false;
                deployBtn.textContent = 'üöÄ ‰∏ÄÈîÆÈÉ®ÁΩ≤ÊâÄÊúâÈ¢ÑËÆæË¥ßÁâ©Âà∞Âå∫ÂùóÈìæ';
            }
        }

        // Êõ¥Êñ∞Âçï‰∏™È¢ÑËÆæË¥ßÁâ©Áä∂ÊÄÅ
        function updatePresetItemStatus(cargoId, status) {
            const presetItem = document.getElementById(`preset_${cargoId}`);
            if (!presetItem) return;

            const statusElement = presetItem.querySelector('.preset-status');
            const statusText = status === 'pending' ? 'ÂæÖÈÉ®ÁΩ≤' :
                              status === 'deploying' ? 'ÈÉ®ÁΩ≤‰∏≠...' :
                              status === 'deployed' ? '‚úÖ Â∑≤ÈÉ®ÁΩ≤' : 'ÂæÖÈÉ®ÁΩ≤';

            presetItem.className = `preset-item ${status}`;
            statusElement.className = `preset-status ${status}`;
            statusElement.textContent = statusText;
        }

        // Êõ¥Êñ∞ÈÉ®ÁΩ≤ËøõÂ∫¶
        function updateDeployProgress(current, total) {
            const progressText = document.getElementById('deployProgress');
            const progressFill = document.getElementById('progressFill');

            if (progressText) progressText.textContent = current;
            if (progressFill) {
                const percentage = (current / total) * 100;
                progressFill.style.width = percentage + '%';
            }
        }

        // Initialize workflow status from localStorage
        function initializeWorkflowStatus() {
            const saved = localStorage.getItem('workflowStatus');
            if (saved) {
                try {
                    const savedStatus = JSON.parse(saved);
                    workflowStatus = { ...workflowStatus, ...savedStatus };
                } catch (e) {
                    console.log('Error loading workflow status:', e);
                }
            }

            // Update UI elements
            for (let i = 1; i <= 4; i++) {
                const stepKey = `step${i}Status`;
                if (workflowStatus[stepKey]) {
                    updateWorkflowStep(i, workflowStatus[stepKey]);
                }
            }

            // Update cargo count
            updateCargoCount();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeWorkflowStatus();
        });

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('createCargo').addEventListener('click', createCargo);
        document.getElementById('trackCargo').addEventListener('click', trackCargo);
        document.getElementById('updateStatus').addEventListener('click', updateStatus);
        document.getElementById('setPrivacy').addEventListener('click', setPrivacy);

        // Initialize app
        init();
    </script>
</body>
</html>