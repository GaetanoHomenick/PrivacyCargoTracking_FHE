<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Cargo Tracking System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöö</text></svg>">
    <script>
        // Fallback script loader
        function loadScript(src, fallbackSrc, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.crossOrigin = 'anonymous';
            script.onload = callback;
            script.onerror = () => {
                console.warn(`Failed to load ${src}, trying fallback...`);
                if (fallbackSrc) {
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = fallbackSrc;
                    fallbackScript.crossOrigin = 'anonymous';
                    fallbackScript.onload = callback;
                    fallbackScript.onerror = () => {
                        console.error(`Failed to load both ${src} and ${fallbackSrc}`);
                        callback(new Error('Script loading failed'));
                    };
                    document.head.appendChild(fallbackScript);
                } else {
                    callback(new Error('Script loading failed'));
                }
            };
            document.head.appendChild(script);
        }

        // Load ethers.js
        loadScript(
            'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
            'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
            (error) => {
                if (error) {
                    console.error('Failed to load Ethers.js:', error);
                } else {
                    console.log('Ethers.js loaded successfully');
                    // Load fhevmjs after ethers is loaded
                    loadScript(
                        'https://unpkg.com/fhevmjs@0.5.0/bundle.web.js',
                        'https://cdn.jsdelivr.net/npm/fhevmjs@0.5.0/bundle.web.js',
                        (fhevmError) => {
                            if (fhevmError) {
                                console.error('Failed to load FHEvm.js:', fhevmError);
                            } else {
                                console.log('FHEvm.js loaded successfully');
                            }
                        }
                    );
                }
            }
        );
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .wallet-address {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            word-break: break-all;
        }

        .connect-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn.btn-success {
            background: #27ae60;
        }

        .btn.btn-success:hover {
            background: #219a52;
        }

        .btn.btn-warning {
            background: #f39c12;
        }

        .btn.btn-warning:hover {
            background: #e67e22;
        }

        .cargo-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .cargo-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .cargo-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .cargo-id {
            font-weight: bold;
            color: #3498db;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .cargo-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-0 { background: #ffeaa7; color: #2d3436; }
        .status-1 { background: #74b9ff; color: white; }
        .status-2 { background: #fd79a8; color: white; }
        .status-3 { background: #00b894; color: white; }

        .tracking-panel {
            grid-column: 1 / -1;
        }

        .location-item {
            background: #f1f2f6;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .location-time {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f1f2f6;
            border-radius: 8px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: white;
            color: #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-section {
            border-top: 2px solid #ddd;
            padding-top: 15px;
            margin-top: 15px;
        }

        .network-info {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .network-info h3 {
            color: #3498db;
            margin-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .info-row .label {
            font-weight: 500;
            color: #666;
        }

        .info-row .value {
            color: #2c3e50;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .wallet-info {
                flex-direction: column;
                align-items: stretch;
            }

            .cargo-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö Private Cargo Tracking</h1>
            <p>Confidential Logistics with FHE Technology</p>
            <div class="wallet-info">
                <div class="wallet-address" id="walletAddress">Wallet Not Connected</div>
                <button class="connect-btn" id="connectWallet">Connect Wallet</button>
            </div>
        </div>

        <div class="network-info">
            <h3>üåê Network Information</h3>
            <div class="info-row">
                <span class="label">Network:</span>
                <span class="value">Zama Sepolia Testnet</span>
            </div>
            <div class="info-row">
                <span class="label">Chain ID:</span>
                <span class="value">8009</span>
            </div>
            <div class="info-row">
                <span class="label">Contract:</span>
                <span class="value">0x1846d67Dcf544B374D59F6d9a9adE4e37719D57A</span>
            </div>
            <div class="info-row">
                <span class="label">Status:</span>
                <span class="value" id="connectionStatus">Checking...</span>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>üì¶ Create Cargo</h2>
                <div class="form-group">
                    <label for="cargoWeight">Weight (kg)</label>
                    <input type="number" id="cargoWeight" placeholder="Enter cargo weight" min="1">
                </div>
                <div class="form-group">
                    <label for="cargoCategory">Category</label>
                    <select id="cargoCategory">
                        <option value="1">Electronics</option>
                        <option value="2">Food</option>
                        <option value="3">Clothing</option>
                        <option value="4">Furniture</option>
                        <option value="5">Chemicals</option>
                        <option value="6">Pharmaceuticals</option>
                        <option value="7">Valuables</option>
                        <option value="8">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cargoValue">Value (ETH)</label>
                    <input type="number" id="cargoValue" step="0.01" placeholder="Cargo value" min="0">
                </div>
                <div class="form-group">
                    <label for="cargoPriority">Priority (1-10)</label>
                    <input type="number" id="cargoPriority" min="1" max="10" value="5">
                </div>
                <div class="form-group">
                    <label for="receiverAddress">Receiver Address</label>
                    <input type="text" id="receiverAddress" placeholder="0x...">
                </div>
                <button class="btn" id="createCargoBtn">Create Cargo</button>
                <div id="createStatus"></div>
            </div>

            <div class="panel">
                <div class="tabs">
                    <div class="tab active" data-tab="shipped">My Shipments</div>
                    <div class="tab" data-tab="received">Received</div>
                </div>

                <div class="tab-content active" id="shipped">
                    <div class="cargo-list" id="shippedCargos">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            No shipments found
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="received">
                    <div class="cargo-list" id="receivedCargos">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            No received cargos found
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel tracking-panel">
                <h2>üìç Track Cargo</h2>
                <div class="form-group">
                    <label for="trackingId">Cargo ID</label>
                    <input type="number" id="trackingId" placeholder="Enter cargo ID to track">
                </div>
                <button class="btn btn-success" id="trackCargoBtn">Track Cargo</button>

                <div id="trackingInfo" style="margin-top: 20px; display: none;">
                    <h3>Cargo Information</h3>
                    <div id="cargoInfo"></div>

                    <h3 style="margin-top: 20px;">Location History</h3>
                    <div id="locationHistory"></div>
                </div>

                <div class="auth-section">
                    <h3>üîê Authorization Management</h3>
                    <div class="form-group">
                        <label for="authCargoId">Cargo ID</label>
                        <input type="number" id="authCargoId" placeholder="Cargo ID">
                    </div>
                    <div class="form-group">
                        <label for="authAddress">Authorized Address</label>
                        <input type="text" id="authAddress" placeholder="0x...">
                    </div>
                    <div class="form-group">
                        <label>Permission Types</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 5px;">
                            <label style="display: flex; align-items: center; margin-bottom: 0;">
                                <input type="checkbox" id="canView" style="margin-right: 5px;">
                                View Info
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 0;">
                                <input type="checkbox" id="canTrack" style="margin-right: 5px;">
                                Track Location
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 0;">
                                <input type="checkbox" id="canUpdate" style="margin-right: 5px;">
                                Update Status
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="authExpires">Authorization Duration (days)</label>
                        <input type="number" id="authExpires" value="30" min="1" max="365">
                    </div>
                    <button class="btn btn-warning" id="grantAuthBtn">Grant Authorization</button>
                </div>
            </div>

            <div class="panel">
                <h2>üöõ Update Location</h2>
                <div class="form-group">
                    <label for="updateCargoId">Cargo ID</label>
                    <input type="number" id="updateCargoId" placeholder="Cargo ID">
                </div>
                <div class="form-group">
                    <label for="latitude">Latitude</label>
                    <input type="number" id="latitude" step="0.000001" placeholder="39.904200">
                </div>
                <div class="form-group">
                    <label for="longitude">Longitude</label>
                    <input type="number" id="longitude" step="0.000001" placeholder="116.407396">
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status">
                        <option value="0">Pending</option>
                        <option value="1">In Transit</option>
                        <option value="2">Arrived</option>
                        <option value="3">Delivered</option>
                    </select>
                </div>
                <button class="btn" id="updateLocationBtn">Update Location</button>

                <div style="margin-top: 20px;">
                    <button class="btn" id="getCurrentLocation" style="background: #9b59b6;">Get Current Location</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = "0x1846d67Dcf544B374D59F6d9a9adE4e37719D57A";
        const CONTRACT_ABI = [
            "function createCargo(uint32 _weight, uint8 _category, uint32 _value, uint8 _priority, address _receiver) external returns (uint32)",
            "function updateLocation(uint32 _cargoId, uint32 _latitude, uint32 _longitude, uint8 _status) external",
            "function grantAuthorization(uint32 _cargoId, address _authorized, bool _canView, bool _canTrack, bool _canUpdate, uint256 _expiresAt) external",
            "function getCargoInfo(uint32 _cargoId) external view returns (address shipper, address receiver, uint256 timestamp, uint256 locationCount)",
            "function getShipperCargos(address _shipper) external view returns (uint32[] memory)",
            "function getReceiverCargos(address _receiver) external view returns (uint32[] memory)",
            "function getLocationCount(uint32 _cargoId) external view returns (uint256)",
            "function checkAuthorization(uint32 _cargoId, address _user) external view returns (bool canView, bool canTrack, bool canUpdate, uint256 expiresAt, bool isExpired)",
            "event CargoCreated(uint32 indexed cargoId, address indexed shipper, address indexed receiver, uint256 timestamp)",
            "event LocationUpdated(uint32 indexed cargoId, address indexed updater, uint256 timestamp)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let fhevm;

        // Check if libraries are loaded
        function checkLibraries() {
            if (typeof ethers === 'undefined') {
                throw new Error('Ethers.js library not loaded');
            }
            if (typeof fhevmjs === 'undefined') {
                throw new Error('FHEvm.js library not loaded');
            }
            return true;
        }

        // Initialize
        async function init() {
            try {
                // Check if libraries are loaded
                checkLibraries();

                // Initialize FHEVM
                fhevm = await fhevmjs.createInstance({
                    chainId: 8009,
                    gatewayUrl: "https://gateway.sepolia.zama.ai",
                });
                console.log("FHEVM initialized successfully");
                updateConnectionStatus("FHE system ready - Connect wallet");
            } catch (error) {
                console.error("Failed to initialize:", error);
                updateConnectionStatus("‚ö†Ô∏è Library loading failed");
                showNotification('Failed to load required libraries: ' + error.message, 'error');
            }

            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('createCargoBtn').addEventListener('click', createCargo);
            document.getElementById('trackCargoBtn').addEventListener('click', trackCargo);
            document.getElementById('updateLocationBtn').addEventListener('click', updateLocation);
            document.getElementById('grantAuthBtn').addEventListener('click', grantAuthorization);
            document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('Please install MetaMask wallet');
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Switch to Zama network
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x1F49' }], // 8009 in hex
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x1F49',
                                chainName: 'Zama Sepolia',
                                nativeCurrency: {
                                    name: 'ZAMA',
                                    symbol: 'ZAMA',
                                    decimals: 18
                                },
                                rpcUrls: ['https://sepolia.zama.ai'],
                                blockExplorerUrls: ['https://sepolia.zama.ai']
                            }]
                        });
                    }
                }

                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                document.getElementById('walletAddress').textContent =
                    `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                document.getElementById('connectWallet').textContent = 'Connected';
                document.getElementById('connectWallet').disabled = true;

                await loadUserCargos();
                updateConnectionStatus("Connected to Zama Sepolia");
                showNotification('Wallet connected successfully!', 'success');
            } catch (error) {
                console.error('Failed to connect wallet:', error);
                updateConnectionStatus("Connection failed");
                showNotification(error.message, 'error');
            }
        }

        // Create cargo
        async function createCargo() {
            try {
                const weight = document.getElementById('cargoWeight').value;
                const category = document.getElementById('cargoCategory').value;
                const value = document.getElementById('cargoValue').value;
                const priority = document.getElementById('cargoPriority').value;
                const receiver = document.getElementById('receiverAddress').value;

                if (!weight || !value || !receiver) {
                    throw new Error('Please fill in all required fields');
                }

                if (!ethers.utils.isAddress(receiver)) {
                    throw new Error('Invalid receiver address format');
                }

                showLoading('createCargoBtn', true);

                const valueInWei = ethers.utils.parseEther(value);
                const tx = await contract.createCargo(
                    parseInt(weight),
                    parseInt(category),
                    parseInt(valueInWei.toString()),
                    parseInt(priority),
                    receiver
                );

                await tx.wait();

                // Clear form
                document.getElementById('cargoWeight').value = '';
                document.getElementById('cargoValue').value = '';
                document.getElementById('receiverAddress').value = '';
                document.getElementById('cargoPriority').value = '5';

                await loadUserCargos();
                showNotification('Cargo created successfully!', 'success');
            } catch (error) {
                console.error('Failed to create cargo:', error);
                showNotification(error.message, 'error');
            } finally {
                showLoading('createCargoBtn', false);
            }
        }

        // Track cargo
        async function trackCargo() {
            try {
                const cargoId = document.getElementById('trackingId').value;
                if (!cargoId) {
                    throw new Error('Please enter a cargo ID');
                }

                showLoading('trackCargoBtn', true);

                const info = await contract.getCargoInfo(parseInt(cargoId));
                const locationCount = await contract.getLocationCount(parseInt(cargoId));

                document.getElementById('cargoInfo').innerHTML = `
                    <div class="cargo-item">
                        <div class="cargo-id">Cargo #${cargoId}</div>
                        <div class="cargo-details">
                            <div><strong>Shipper:</strong> ${info.shipper.slice(0, 10)}...</div>
                            <div><strong>Receiver:</strong> ${info.receiver.slice(0, 10)}...</div>
                            <div><strong>Created:</strong> ${new Date(info.timestamp * 1000).toLocaleString()}</div>
                            <div><strong>Locations:</strong> ${locationCount} records</div>
                        </div>
                    </div>
                `;

                document.getElementById('locationHistory').innerHTML =
                    locationCount > 0 ?
                    `<div class="location-item">${locationCount} location records (authorization required for details)</div>` :
                    '<div class="location-item">No location records found</div>';

                document.getElementById('trackingInfo').style.display = 'block';
                showNotification('Cargo tracked successfully!', 'success');
            } catch (error) {
                console.error('Failed to track cargo:', error);
                showNotification(error.message, 'error');
                document.getElementById('trackingInfo').style.display = 'none';
            } finally {
                showLoading('trackCargoBtn', false);
            }
        }

        // Update location
        async function updateLocation() {
            try {
                const cargoId = document.getElementById('updateCargoId').value;
                const lat = document.getElementById('latitude').value;
                const lng = document.getElementById('longitude').value;
                const status = document.getElementById('status').value;

                if (!cargoId || !lat || !lng) {
                    throw new Error('Please fill in all required fields');
                }

                showLoading('updateLocationBtn', true);

                // Convert coordinates to integers (multiply by 1000000 to preserve 6 decimal places)
                const latInt = Math.round(parseFloat(lat) * 1000000);
                const lngInt = Math.round(parseFloat(lng) * 1000000);

                const tx = await contract.updateLocation(
                    parseInt(cargoId),
                    latInt,
                    lngInt,
                    parseInt(status)
                );

                await tx.wait();
                showNotification('Location updated successfully!', 'success');
            } catch (error) {
                console.error('Failed to update location:', error);
                showNotification(error.message, 'error');
            } finally {
                showLoading('updateLocationBtn', false);
            }
        }

        // Grant authorization
        async function grantAuthorization() {
            try {
                const cargoId = document.getElementById('authCargoId').value;
                const authAddress = document.getElementById('authAddress').value;
                const canView = document.getElementById('canView').checked;
                const canTrack = document.getElementById('canTrack').checked;
                const canUpdate = document.getElementById('canUpdate').checked;
                const days = document.getElementById('authExpires').value;

                if (!cargoId || !authAddress) {
                    throw new Error('Please fill in cargo ID and authorized address');
                }

                if (!ethers.utils.isAddress(authAddress)) {
                    throw new Error('Invalid authorized address format');
                }

                if (!canView && !canTrack && !canUpdate) {
                    throw new Error('Please select at least one permission type');
                }

                showLoading('grantAuthBtn', true);

                const expiresAt = Math.floor(Date.now() / 1000) + (parseInt(days) * 24 * 60 * 60);

                const tx = await contract.grantAuthorization(
                    parseInt(cargoId),
                    authAddress,
                    canView,
                    canTrack,
                    canUpdate,
                    expiresAt
                );

                await tx.wait();
                showNotification('Authorization granted successfully!', 'success');
            } catch (error) {
                console.error('Failed to grant authorization:', error);
                showNotification(error.message, 'error');
            } finally {
                showLoading('grantAuthBtn', false);
            }
        }

        // Get current location
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation not supported by browser', 'error');
                return;
            }

            showLoading('getCurrentLocation', true);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                    document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                    showNotification('Location retrieved successfully!', 'success');
                    showLoading('getCurrentLocation', false);
                },
                (error) => {
                    showNotification('Failed to get location: ' + error.message, 'error');
                    showLoading('getCurrentLocation', false);
                }
            );
        }

        // Load user cargos
        async function loadUserCargos() {
            try {
                const [shippedIds, receivedIds] = await Promise.all([
                    contract.getShipperCargos(userAddress),
                    contract.getReceiverCargos(userAddress)
                ]);

                await Promise.all([
                    loadCargoList('shippedCargos', shippedIds, 'shipped'),
                    loadCargoList('receivedCargos', receivedIds, 'received')
                ]);
            } catch (error) {
                console.error('Failed to load user cargos:', error);
            }
        }

        // Load cargo list
        async function loadCargoList(containerId, cargoIds, type) {
            const container = document.getElementById(containerId);

            if (cargoIds.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;">No ${type} cargos found</div>`;
                return;
            }

            let html = '';
            for (const id of cargoIds) {
                try {
                    const info = await contract.getCargoInfo(id);
                    const locationCount = await contract.getLocationCount(id);

                    html += `
                        <div class="cargo-item">
                            <div class="cargo-id">Cargo #${id}</div>
                            <div class="cargo-details">
                                <div><strong>Counterpart:</strong> ${type === 'shipped' ?
                                    info.receiver.slice(0, 10) + '...' :
                                    info.shipper.slice(0, 10) + '...'}</div>
                                <div><strong>Created:</strong> ${new Date(info.timestamp * 1000).toLocaleDateString()}</div>
                                <div><strong>Locations:</strong> ${locationCount} records</div>
                                <div><strong>Status:</strong> <span class="status-badge status-1">Active</span></div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`Failed to load cargo ${id}:`, error);
                }
            }

            container.innerHTML = html || `<div style="text-align: center; padding: 20px; color: #666;">No ${type} cargos found</div>`;
        }

        // Switch tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Show loading state
        function showLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<div class="loading"></div> Processing...';
            } else {
                button.disabled = false;
                // Restore button text
                const buttonTexts = {
                    'createCargoBtn': 'Create Cargo',
                    'trackCargoBtn': 'Track Cargo',
                    'updateLocationBtn': 'Update Location',
                    'grantAuthBtn': 'Grant Authorization',
                    'getCurrentLocation': 'Get Current Location'
                };
                button.innerHTML = buttonTexts[buttonId] || 'Submit';
            }
        }

        // Update connection status
        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        // Initialize app with delay to ensure all scripts are loaded
        window.addEventListener('load', () => {
            setTimeout(init, 2000); // 2s delay to ensure all scripts are loaded
        });
    </script>
</body>
</html>